#!/usr/bin/env bash
set -e  # Exit on error

# Args
BUILD_VENV="${1:-tvm-build-venv}"
TVM_SOURCE="${2:-bundled}"  # bundled or custom

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
WHEELS_DIR="${REPO_ROOT}/wheels"

source "$(conda info --base)/etc/profile.d/conda.sh"

conda create -y -n ${BUILD_VENV} -c conda-forge \
    "llvmdev=19" \
    "cmake>=3.24" \
    git \
    zstd \
    python=3.13

conda activate ${BUILD_VENV}

# Set library path for cmake to find zstd
export DYLD_LIBRARY_PATH="$CONDA_PREFIX/lib:$DYLD_LIBRARY_PATH"

# Determine TVM directory based on source selection
if [ "${TVM_SOURCE}" = "custom" ]; then
    TVM_DIR="${REPO_ROOT}/tvm"
    echo "Using custom TVM from ${TVM_DIR}"
    if [ ! -d "${TVM_DIR}" ]; then
        echo "Error: Custom TVM directory not found at ${TVM_DIR}"
        echo "Please clone TVM to ${TVM_DIR} or select bundled TVM option"
        exit 1
    fi
else
    TVM_DIR="${REPO_ROOT}/mlc-llm/3rdparty/tvm"
    echo "Using bundled TVM from ${TVM_DIR}"
    if [ ! -d "${TVM_DIR}" ]; then
        echo "Error: Bundled TVM directory not found at ${TVM_DIR}"
        echo "Please ensure mlc-llm is properly initialized with submodules"
        exit 1
    fi
fi

cd "${TVM_DIR}"
# create the build directory
rm -rf build && mkdir build && cd build
# specify build requirements in `config.cmake`
cp ../cmake/config.cmake .

# controls default compilation flags (use sed to replace existing values)
sed -i '' 's/set(CMAKE_BUILD_TYPE .*/set(CMAKE_BUILD_TYPE Release)/' config.cmake
# LLVM is a must dependency
sed -i '' 's|set(USE_LLVM .*)|set(USE_LLVM "llvm-config --ignore-libllvm --link-static")|' config.cmake
sed -i '' 's/set(HIDE_PRIVATE_SYMBOLS .*/set(HIDE_PRIVATE_SYMBOLS ON)/' config.cmake
# GPU SDKs - enable Metal for macOS
sed -i '' 's/set(USE_CUDA .*/set(USE_CUDA OFF)/' config.cmake
sed -i '' 's/set(USE_ROCM .*/set(USE_ROCM OFF)/' config.cmake
sed -i '' 's/set(USE_METAL .*/set(USE_METAL ON)/' config.cmake
sed -i '' 's/set(USE_VULKAN .*/set(USE_VULKAN OFF)/' config.cmake
sed -i '' 's/set(USE_OPENCL .*/set(USE_OPENCL OFF)/' config.cmake

cmake .. && make -j4
cd ..

# Build wheels and copy to wheels directory
mkdir -p "${WHEELS_DIR}"

# Clean CMake cache and Makefiles to avoid Make/Ninja conflict
# but keep the compiled libraries in build/
cd build
rm -f Makefile CMakeCache.txt cmake_install.cmake
rm -rf CMakeFiles
cd ..

# Build TVM wheel from the tvm root directory (where pyproject.toml is)
pip install build
python -m build --wheel --outdir "${WHEELS_DIR}"

echo "TVM wheels created in ${WHEELS_DIR}"

